rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isSelf(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function requesterDocPath() {
      return /databases/$(database)/documents/users/$(request.auth.uid);
    }

    function requesterProfile() {
      return isSignedIn() && exists(requesterDocPath())
        ? get(requesterDocPath()).data
        : null;
    }

    function tokenRole() {
      return isSignedIn() && request.auth.token.role is string
        ? request.auth.token.role
        : null;
    }

    function profileRole() {
      return requesterProfile() != null && requesterProfile().role is string
        ? requesterProfile().role
        : null;
    }

    function isAdmin() {
      return isSignedIn() &&
        (tokenRole() == 'admin' || profileRole() == 'admin');
    }

    function isPolice() {
      return isSignedIn() &&
        (tokenRole() == 'police' || profileRole() == 'police');
    }

    function requesterStationId() {
      return isSignedIn() && request.auth.token.stationId is string
        ? request.auth.token.stationId
        : (requesterProfile() != null && requesterProfile().stationId is string
          ? requesterProfile().stationId
          : null);
    }

    function isAssignedPolice(resourceData) {
      return isPolice() &&
        resourceData.assignedStationId is string &&
        requesterStationId() != null &&
        resourceData.assignedStationId == requesterStationId();
    }

    match /users/{userId} {
      allow read: if isSelf(userId) || isAdmin() ||
        (isSignedIn() && resource.data.role == 'user');
      allow create: if isSelf(userId)
        && (
          !('role' in request.resource.data) ||
          request.resource.data.role == 'user'
        )
        && !('stationId' in request.resource.data)
        && !('policeId' in request.resource.data);
      allow update: if (
          isSelf(userId) &&
          request.resource.data.role == resource.data.role &&
          request.resource.data.stationId == resource.data.stationId &&
          request.resource.data.policeId == resource.data.policeId
        ) || isAdmin();
      allow delete: if isSelf(userId) || isAdmin();

      match /emergency_contacts/{contactId} {
        allow create, read, update, delete: if isSelf(userId);
      }

      match /incoming_sos/{alertId} {
        allow read: if isSelf(userId);

        allow create: if isSignedIn()
          && request.resource.data.sourceUserId == request.auth.uid
          && request.resource.data.sourceContactId is string
          && request.resource.data.sosId is string
          && linkedEmergencyContactTargetsUser(
            request.auth.uid,
            request.resource.data.sourceContactId,
            userId
          );

        allow update: if isSelf(userId)
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['isRead'])
          && request.resource.data.isRead is bool;

        allow delete: if isSelf(userId);
      }
    }

    match /police_registration_requests/{requestId} {
      allow read: if isAdmin();
      allow create, update, delete: if false;
    }

    match /sos/{sosId} {
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.status == 'active';

      allow read: if isSignedIn()
        && (
          resource.data.userId == request.auth.uid ||
          isAssignedPolice(resource.data)
        );

      allow update: if isSignedIn() && (
        isUserCancellationUpdate() ||
        isPoliceStatusUpdate() ||
        isUserMediaUpdate()
      );

      allow delete: if false;

      function isUserCancellationUpdate() {
        return resource.data.userId == request.auth.uid
          && resource.data.status == 'active'
          && resource.data.timestamp is timestamp
          && request.resource.data.status == 'cancelled'
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['status', 'cancelledAt'])
          && request.time < resource.data.timestamp + duration.value(30, 's');
      }

      function isPoliceStatusUpdate() {
        return isAssignedPolice(resource.data)
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['status'])
          && (
            (resource.data.status == 'active' && request.resource.data.status == 'accepted') ||
            (resource.data.status == 'accepted' && request.resource.data.status == 'resolved')
          );
      }

      function isUserMediaUpdate() {
        return resource.data.userId == request.auth.uid
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['mediaUrl'])
          && request.resource.data.mediaUrl is string
          && request.resource.data.mediaUrl.size() > 0;
      }
    }

    match /police_stations/{stationId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    function linkedEmergencyContactTargetsUser(sourceUserId, contactId, targetUserId) {
      return exists(
          /databases/$(database)/documents/users/$(sourceUserId)/emergency_contacts/$(contactId)
        )
        && get(
          /databases/$(database)/documents/users/$(sourceUserId)/emergency_contacts/$(contactId)
        ).data.contactUserId == targetUserId;
    }
  }
}
